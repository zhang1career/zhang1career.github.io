<p>layout: post
title:  Splittable Ring Buffer
date:   2021-03-31 16:52:00 +0800
categories: data-structure</p>

<h1 id="splittable-ring-buffer">Splittable Ring Buffer</h1>

<p>Splittable ring buffer is a ring buffer that can be split into several parts. Each part is still a ring buffer.</p>

<h2 id="split-principal">Split Principal</h2>

<p>Writting to a ring buffer is usually by a continnously increasing index. Suppose the ring buffer to be split into <em>s</em> parts, then the addressing of each split<em><sub>i</sub></em> needs a <em>step</em> of <em>n</em> and an <em>offset</em> of <em>i</em>, with both <em>s</em> and <em>i</em> belonging to <em>Z<sup>+</sup></em>.</p>

<p>For example, if the tail of the <em>split<sub>i</sub></em> addresses <em>memory[p step + offset]</em>, with <em>p</em> belonging to <em>Z<sup>+</sup></em>. Given <em>index = i</em>, a <em>data<sub>i</sub></em> is write to <em>memory[i]</em>, then the <em>split<sub>i</sub></em> gets a new item in <em>memory[(p+1) step + offset]</em>, which values <em>data<sub>i</sub></em>.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><em>memory</em></th>
      <th style="text-align: center">…</th>
      <th style="text-align: center"><em>0</em></th>
      <th style="text-align: center"><em>1</em></th>
      <th style="text-align: center">…</th>
      <th style="text-align: center"><em>i</em></th>
      <th style="text-align: center">…</th>
      <th style="text-align: center"><em>s-1</em></th>
      <th style="text-align: center">…</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>index</em></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"><em>i</em></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td style="text-align: center"><em>split<sub>0</sub></em></td>
      <td style="text-align: center">…</td>
      <td style="text-align: center"><em>data<sub>0</sub></em></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">…</td>
    </tr>
    <tr>
      <td style="text-align: center"><em>split<sub>1</sub></em></td>
      <td style="text-align: center">…</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"><em>data<sub>1</sub></em></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">…</td>
    </tr>
    <tr>
      <td style="text-align: center">…</td>
      <td style="text-align: center">…</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">…</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">…</td>
    </tr>
    <tr>
      <td style="text-align: center"><em>split<sub>i</sub></em></td>
      <td style="text-align: center">…</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"><em>data<sub>i</sub></em></td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">…</td>
    </tr>
    <tr>
      <td style="text-align: center">…</td>
      <td style="text-align: center">…</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">…</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">…</td>
    </tr>
    <tr>
      <td style="text-align: center"><em>split<sub>s</sub></em></td>
      <td style="text-align: center">…</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"><em>data<sub>s</sub></em></td>
      <td style="text-align: center">…</td>
    </tr>
  </tbody>
</table>

<p>Specially, when the origin ring buffer’s length is a power-2 number, <em>2<sup>r</sup></em> for instance. And the split number <em>s</em> is also a power-2 number, 2<em><sup>n</sup></em> for instance, with both <em>r</em> and <em>n</em> belonging to <em>Z<sup>+</sup></em> and <em>r &gt;= n</em>. Then addressing of the ring buffer can be achieved with just masking <em>(2<sup>r-n</sup> step + offset)</em> overflow.</p>

<p><strong>Then the split parts are all rings too.</strong></p>

<h2 id="demo-code">Demo Code</h2>

<p>Calculate <em>step</em> and <em>offset</em>, then split the ring buffer into <em>num</em> parts.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">split</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">step</span> <span class="o">=</span> <span class="nc">BinaryUtils</span><span class="o">.</span><span class="na">smallestPow2GreaterThanOrEqualTo</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">step</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">holdingChildren</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">SplittableRingBuffer</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">step</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="no">IO_TYPE</span><span class="o">.</span><span class="na">WO</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Write to buffer</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isFull</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">setElement</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
    <span class="n">stepWriteIndex</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">isFull</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Read from buffer</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="no">E</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="n">getElement</span><span class="o">();</span>
    <span class="n">stepReadIndex</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Relative codes</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">smallestPow2GreaterThanOrEqualTo</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">num</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">smallestPow2GreaterThan</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setElement</span><span class="o">(</span><span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">data</span><span class="o">[</span><span class="n">normalize</span><span class="o">(</span><span class="n">writeIndex</span><span class="o">)]</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="no">E</span> <span class="nf">getElement</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">[</span><span class="n">normalize</span><span class="o">(</span><span class="n">readIndex</span><span class="o">)];</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">stepWriteIndex</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">writeIndex</span> <span class="o">+=</span> <span class="n">step</span><span class="o">;</span>
    <span class="n">readableLength</span><span class="o">++;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">stepReadIndex</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">readIndex</span> <span class="o">+=</span> <span class="n">step</span><span class="o">;</span>
    <span class="n">readableLength</span><span class="o">--;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">int</span> <span class="nf">normalize</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">index</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">readableLength</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isFull</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">readableLength</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>Split mechanism separates a ring buffer into several parts, which can be read/write seperately. Some pingpong buffer can be designed based on this.</p>

<h2 id="referance">Referance</h2>

<p><a href="https://github.com/zhang1career/javalab/blob/master/datastruct/src/main/java/datastruct/ringbuffer/SplittableRingBuffer.java">Source code</a></p>

