---
layout: post
title:  环形缓冲的一种同态寻址的切分方法
date:   2021-04-04 21:02:00 +0800
categories: [algorithm, ringbuffer]
---

# 环形缓冲的一种同态寻址的切分方法

## 0. 背景

### 0.1. 成环机制
长度 N（其中 N为正整数，下同）的连续存储空间的成环机制，是将随机地址 addr（其中 addr >= 0）对 N 做模运算，所得数值会在 [0, N-1] 闭区间内循环分布。以此数值寻址就会使存储空间首尾相连而形成环。

特别地，当 N 为 2 的非负整数次幂时，对 N 做模运算可以简化成对 N-1 做位与运算。本文讨论通常情况，至于这种特殊情况，包含在通常情况之中。

### 0.2. 寻址方法

在长度 N 的环形缓冲中，相邻元素的地址间隔为 1。假设以地址为 offset 的某个元素作为第 0 个元素，那么第 p 个元素的地址为

$$(1 * p + offset) \% N \tag{0.1}$$

其中 % 为模运算，下同。

## 1. 切分方法

对于长度 N 的环形缓冲，将元素次第反复地切分成 M 组（其中 N、M 均为正整数，N >= M，N 可被 M 整除），使得任意 1 个元素属于且仅属于 1 个组。可知每组长度均为 N/M。由于 N/M 是正整数，依照上文的成环机制，可知切分得到的任意一组都是环。

将第 m 组（其中 0 <= m <= M-1，下同）的第 i 个元素记为 E_m_i，切分方法如下图所示: 

```E_0_0, E_1_0, ..., E_M-1_0, E_0_1, E_1_1, ..., E_M-1_1, ..., E_0_N/M-1, E_1_N/M-1, ..., E_M-1_N/M-1```

对于任意的第 m 组，相邻元素间隔为 M，第 0 个元素地址为 m。那么第 p 个元素的寻址方法为

$$(M * p + m) \% N \tag{1.1}$$

由此可见，将长度 N 的环形缓冲（简称父环），按照上述切分方法，可以切分成 M 个长度为 N/M 的环形缓冲（简称子环），任意2个子环不相交。对比公式 (0.1) 和 (1.1) 可知，对于任意子环的任意元素，具有和父环元素同态的寻址方式。

## 2. 功能

### 2.1. 简化设计

由于父环和子环具有同态的寻址方式，可以仅使用一套程序实现父环或任意子环的寻址，简化程序设计。

### 2.2. 读写分离

切分之后，子环之间可以并发寻址; 父环与子环之间也可以通过有锁或无锁的方式实现并发寻址。并发过程中，环与环之间的读写相互不影响。这种读写分离的实现，可以提高环形缓冲的 i/o 吞吐率。

### 2.3. 拓扑应用

可以构建若干拓扑应用。比如：1个父环写入，多个子环读取，可以实现数据扇出。多个子环写入，1个父环读取，可以实现数据归并。

